agents:
  provider: "gcp"
  machineType: "n1-standard-2"
  useVault: true
  image: family/enterprise-search-ubuntu-2204-connectors-py

env:
  DOCKERFILE_FTEST_PATH: "Dockerfile.ftest.wolfi"

steps:
  - label: ":face_with_peeking_eye: Lint"
    command: ".buildkite/run_linter.sh"
    env:
      PYTHON_VERSION: "3.10" # We don't really care about linter on multiple versions for now
    timeout_in_minutes: 5

  - label: ":pytest: Test with Python {{ matrix }}"
    command: ".buildkite/run_tests.sh"
    env:
      PYTHON_VERSION: "{{ matrix }}"
    timeout_in_minutes: 5
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"

  - label: ":shipit: Smoke test"
    command: ".buildkite/run_functional_test.sh"
    env:
      PYTHON_VERSION: "3.10" # TODO: can actually do a matrix too
      CONNECTOR: "dir"
      DATA_SIZE: "small"
    timeout_in_minutes: 45
    agents:
      machineType: "n1-standard-8"

  - label: ":sweating: Checking for changes in connectors"
    plugins:
      monebag/monorepo-diff#v2.5.9:
        diff: ".buildkite/diff ${BUILDKITE_COMMIT}"
        env:
          PYTHON_VERSION: "3.10"
          DATA_SIZE: "small"
        wait: false
        watch:
          - path:
            - "connectors/sources/mysql.py"
            - "tests/sources/fixtures/mysql/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ MySQL"
              env:
                CONNECTOR: "mysql"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/network_drive.py"
            - "tests/sources/fixtures/network_drive/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Network Drive"
              env:
                CONNECTOR: "network_drive"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/s3.py"
            - "tests/sources/fixtures/s3/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Amazon S3"
              env:
                CONNECTOR: "s3"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/google_cloud_storage.py"
            - "tests/sources/fixtures/google_cloud_storage/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Google Cloud Storage"
              env:
                CONNECTOR: "google_cloud_storage"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/azure_blob_storage.py"
            - "tests/sources/fixtures/azure_blob_storage/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Azure Blob Storage"
              env:
                CONNECTOR: "azure_blob_storage"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/postgresql.py"
            - "tests/sources/fixtures/postgresql/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Postgresql"
              env:
                CONNECTOR: "postgresql"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/directory.py"
            - "tests/sources/fixtures/dir/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ System Directory"
              env:
                CONNECTOR: "dir"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/oracle.py"
            - "tests/sources/fixtures/oracle/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Oracle Database"
              env:
                CONNECTOR: "oracle"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/sharepoint_server.py"
            - "tests/sources/fixtures/sharepoint_server/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Sharepoint Server"
              env:
                CONNECTOR: "sharepoint_server"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/sharepoint_online.py"
            - "tests/sources/fixtures/sharepoint_online/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Sharepoint Online"
              env:
                CONNECTOR: "sharepoint_online"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/mssql.py"
            - "tests/sources/fixtures/mssql/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Microsoft SQL"
              env:
                CONNECTOR: "mssql"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/jira.py"
            - "connectors/sources/atlassian.py"
            - "tests/sources/fixtures/jira/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Jira"
              env:
                CONNECTOR: "jira"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/confluence.py"
            - "connectors/sources/atlassian.py"
            - "tests/sources/fixtures/confluence/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Confluence"
              env:
                CONNECTOR: "confluence"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/servicenow.py"
            - "tests/sources/fixtures/servicenow/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ ServiceNow"
              env:
                CONNECTOR: "servicenow"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/mongo.py"
            - "tests/sources/fixtures/mongodb/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ MongoDB"
              env:
                CONNECTOR: "mongodb"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/github.py"
            - "tests/sources/fixtures/github/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ GitHub"
              env:
                CONNECTOR: "github"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/google_drive.py"
            - "tests/sources/fixtures/google_drive/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Google Drive"
              env:
                CONNECTOR: "google_drive"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/dropbox.py"
            - "tests/sources/fixtures/dropbox/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Dropbox"
              env:
                CONNECTOR: "dropbox"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/onedrive.py"
            - "tests/sources/fixtures/onedrive/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ OneDrive"
              env:
                CONNECTOR: "onedrive"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/salesforce.py"
            - "tests/sources/fixtures/salesforce/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Salesforce"
              env:
                CONNECTOR: "salesforce"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/zoom.py"
            - "tests/sources/fixtures/zoom/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Zoom"
              env:
                CONNECTOR: "zoom"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/box.py"
            - "tests/sources/fixtures/box/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Box"
              env:
                CONNECTOR: "box"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/microsoft_teams.py"
            - "tests/sources/fixtures/microsoft_teams/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Microsoft Teams"
              env:
                CONNECTOR: "microsoft_teams"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"

          - path:
            - "connectors/sources/notion.py"
            - "tests/sources/fixtures/notion/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Notion"
              env:
                CONNECTOR: "notion"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"
          
          - path:
            - "connectors/sources/redis.py"
            - "tests/sources/fixtures/redis/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ Redis"
              env:
                CONNECTOR: "redis"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"
            
          - path:
            - "connectors/sources/graphql.py"
            - "tests/sources/fixtures/graphql/**"
            - "tests/sources/fixtures/fixture.py"
            - "${DOCKERFILE_FTEST_PATH}"
            - "requirements/**"
            config:
              label: "ðŸ”¨ GraphQL"
              env:
                CONNECTOR: "graphql"
              command:
                - ".buildkite/run_functional_test.sh"
              artifact_paths:
                - "perf8-report-*/**/*"
