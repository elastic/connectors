#!/bin/bash
# Produces a list of changed files between two commits (works for merges and
# regular commits).
# Used in conjunction with the monorepo-diff-buildkite-plugin to determine
# which pipelines to upload/trigger based on the files changed.

[ $# -lt 1 ] && { echo "argument is missing."; exit 1; }

COMMIT=$1

if [ -n $BUILDKITE_PULL_REQUEST_BASE_BRANCH ]; then
  # git repository here is a shallow clone. Because of it, we need to fetch
  # the base branch before doing the diff.
  # We fetch last 100 commits of the branch, probably smaller will be fine
  # but for now this costs nothing.
  # We might reconsider this code later if problems happen.
  echo "Checking against a base branch: $BUILDKITE_PULL_REQUEST_BASE_BRANCH"
  git fetch origin $BUILDKITE_PULL_REQUEST_BASE_BRANCH --depth=100
  HEAD_BRANCH="origin/$BUILDKITE_PULL_REQUEST_BASE_BRANCH"
  MERGE_BASE=$(git merge-base "$HEAD_BRANCH" "$COMMIT")
  git diff --raw "$COMMIT".."$MERGE_BASE" | awk '{print $6; if($7) {print $7}}'
else
  echo "Checking against the head of the current branch" 
  git diff --raw HEAD~1 | awk '{print $6; if($7) {print $7}}'
fi
