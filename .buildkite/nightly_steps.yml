definitions:
  retries: &retries
    retry:
      automatic:
        - exit_status: -1  # Connection to the Agent was lost
          signal_reason: none
          limit: 2
        - exit_status: 255  # Timeout
          signal_reason: none
          limit: 2
        - exit_status: 2  # Flaky test
          signal_reason: none
          limit: 2
  ftest_defaults: &ftest_defaults
    command: ".buildkite/run_functional_test.sh"
    timeout_in_minutes: 45
    artifact_paths:
      - "perf8-report-*/**/*"
    matrix:
      - "3.10"
      - "3.11"

notify:
  - if: 'build.branch =~ /^((main)|([0-9]+\.[0-9]+))\$/ && (build.state == "failed" || pipeline.started_passing)'
    slack:
      channels:
        - "#search-et-alerts"
      message: "${BUILDKITE_MESSAGE}"

env:
  DOCKERFILE_PATH: "Dockerfile.wolfi"

steps:
  - label: "ðŸ”¨ [Python {{ matrix }}] MySQL"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "mysql"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Network Drive"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "network_drive"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Amazon S3"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "s3"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Google Cloud Storage"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "google_cloud_storage"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Azure Blob Storage"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "azure_blob_storage"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Postgresql"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "postgresql"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] System Directory"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "dir"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Oracle Database"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "oracle"
      DATA_SIZE: "small"
      SKIP_AARCH64: "true"
  - label: "ðŸ”¨ [Python {{ matrix }}] Sharepoint Server"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "sharepoint_server"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Sharepoint Online"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "sharepoint_online"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Microsoft SQL"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "mssql"
      DATA_SIZE: "small"
      SKIP_AARCH64: "true"
  - label: "ðŸ”¨ [Python {{ matrix }}] Jira"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "jira"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Confluence"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "confluence"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] ServiceNow"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "servicenow"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] MongoDB"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "mongodb"
      DATA_SIZE: "small"
#   - label: "ðŸ”¨ [Python {{ matrix }}] MongoDB Serverless"
#     <<: *retries
#     command: ".buildkite/run_functional_test.sh"
#     env:
#       PYTHON_VERSION: "{{ matrix }}"
#       CONNECTOR: "mongodb_serverless"
#       DATA_SIZE: "small"
#     matrix:
#       - "3.10"
#       - "3.11"
#     artifact_paths:
#       - "perf8-report-*/**/*"
  - label: "ðŸ”¨ [Python {{ matrix }}] GitHub"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "github"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Google Drive"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "google_drive"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Dropbox"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "dropbox"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] OneDrive"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "onedrive"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Salesforce"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "salesforce"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Zoom"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "zoom"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Box"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "box"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Notion"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "notion"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Redis"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "redis"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] GraphQL"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "graphql"
      DATA_SIZE: "small"
  - label: "ðŸ”¨ [Python {{ matrix }}] Sandfly"
    <<: *retries
    <<: *ftest_defaults
    env:
      PYTHON_VERSION: "{{ matrix }}"
      CONNECTOR: "sandfly"
      DATA_SIZE: "small"
